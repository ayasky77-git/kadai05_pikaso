<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>picaso atelier</title>
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+JP" rel="stylesheet" />
    <link rel="stylesheet" href="./css/picaso.css">
<body>
    <div id="atelier_room">
        <section id="baseinfo_area">
            <div id="atelier_name">
            </div>

            <div id="room_id_frame">
                <input type="text" id="room_id" placeholder="へやID">
                <p id="room_id_text">↑このIDを友達におしえよう</p>
            </div>
            
            <div id="odai_frame">
                おだい<br>『---』
            </div>

            <div id="timelimit_frame">
                のこり時間
                <p id="timelimit"></p>
            </div>
        </section>

        <section id="drow_area">
            <div id="palette">
                <div id="color_area">
                    <p>色</p>
                    <input id="color-palette" type="color" value=#000000>
                </div>

                <div id="line_width">
                    <p>太さ</p>
                    <div id="line_weight_range">
                        <input type="range" id="line_weight" name="line_weight" min="1" max="10" step="1" value="3">
                        <p id="current_value_line"></p>
                    </div>

                </div>

                <div id="speed_area">
                    <p>かいてん</p>
                    <div id="speed_range">
                        <input type="range" id="speed" name="speed" min="0" max="5" step="1" value="0">
                        <p id="current_value_speed"></p>
                    </div>
                </div>
            </div>
            <canvas id="drow" width="500" height="500" style="background-color:#FBF9F1; box-shadow: 0px 4px 4px 0px rgba(0, 0, 0, 0.25); border-radius: 6px;"></canvas>
        </section>

        <section id="chat_area">
            <div id="chat">
                <div id="chat_rireki">
                    chatりれき
                </div>
                <div id="chat_textbox">
                    <input type="text" id="text_message" placeholder="テキストを入力">
                    <button id="chat_send">そうしん</button>
                </div>
            </div>

            <button id="clear_btn">絵をけす</button>
            <button id="one_more">もう1回やる</button>
            <button id="go_top">おわる</button>
        </section>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";

        // DBに対してデータの追加や取得ができるようにする
        import {
            getFirestore,
            collection,
            addDoc,
            serverTimestamp,
            onSnapshot,
            doc,
            query,
            orderBy,
            updateDoc,
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "",
            authDomain: "picaso-93617.firebaseapp.com",
            projectId: "picaso-93617",
            storageBucket: "picaso-93617.firebasestorage.app",
            messagingSenderId: "347456870584",
            appId: "1:347456870584:web:1952358594e673580efc4d"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);

        // 変数DBにfirestoreのインスタンスを入れる
        const db = getFirestore(app);

        // 共通のルームIDの定義
        let currentRoomId = "";
        let drawer_name ="";
        let time_limit = 15;
        // カウントダウンフラグ
        let countdown_flg = 0;
        // カウントダウン（setInterval）のIDを保持する変数
        let cnDownTimerId = null; 
        // スタート準備（setTimeout）のIDを保持する変数
        let startTimerId = null;
        // 速さの初期設定
        let spin_speed = 0;


        // roomsデータ、chatデータ取得処理
        onSnapshot(collection(db, "rooms"), (querySnapshot) => {
            // firestore 形式のデータである querySnapshot.docs を入力する
            const documents = roomsDocuments(querySnapshot.docs);
            // 配列形式のデータを出力する
            const room_id = getRoomDataByUrlParameter(documents);
            if (!room_id) {
                 console.warn("対象のルームIDが見つかりません。");
                 return;
            }
            currentRoomId = room_id[0];
            drawer_name = room_id[1];
            time_limit = room_id[2];
            $("#atelier_name").html(room_id[1]+"さんの<br>アトリエ");
            $('#room_id').val(room_id[0]);
            $('#timelimit').text(room_id[2]+"びょう");

            // chatデータを取得する処理
            // データ取得処理
            const q = query(collection(db, 'rooms', currentRoomId, 'chat'), orderBy("timestamp", "asc") );            
            onSnapshot(q, (querySnapshot) => {
                // なぞのデータを綺麗なデータに変換
                const documents=chatDocuments(querySnapshot.docs);
                // きれいなデータをタグに変換
                const elements_chat =chatElements(documents);
                // タグを表示する
                $('#chat_rireki').html(elements_chat);
                // 最新メッセージが見えるようにスクロール
                $('#chat_rireki').scrollTop($('#chat_rireki')[0].scrollHeight);
            });
        });

        // chat送信処理
        $('#chat_send').on('click',function(){
            if(!currentRoomId){
                alert("ルームIDが未設定のため、チャットを送信できません。");
                return;
            }

            const data_chat={
                user_name:drawer_name,
                message:$('#text_message').val(),
                timestamp:serverTimestamp(),
            }

            // chatデータを保存
            addDoc(collection(db, 'rooms', currentRoomId, 'chat'),data_chat);             
            $('#text_message').val('');;
        });

        function convertTimestampToDatetime(timestamp) {
            let date;
            date = timestamp.toDate();

            // 例: YYYY/MM/DD HH:MM形式で返す
            const Y = date.getFullYear();
            const M = ('0' + (date.getMonth() + 1)).slice(-2);
            const D = ('0' + date.getDate()).slice(-2);
            const h = ('0' + date.getHours()).slice(-2);
            const m = ('0' + date.getMinutes()).slice(-2);
            const s = ('0' + date.getSeconds()).slice(-2);
            
            return `${Y}/${M}/${D} ${h}:${m}`;
        }

        // 「Firestore 形式のデータ」を入力して「配列形式のデータ」を出力する関数を追加する
        function roomsDocuments(fireStoreDocs) {
            const documents_room = [];
            fireStoreDocs.forEach(function (doc) {
                const document_room = {
                id: doc.id,
                data: doc.data(),
                };
                documents_room.push(document_room);
            });
            return documents_room;
        }

        // 「配列形式のデータ」のデータとパラメータのroomIdで該当のデータを探す
        function getRoomDataByUrlParameter(roomsDocuments) {
            // URLパラメータ 'roomId' の取得
            const urlParams = new URLSearchParams(window.location.search);
            const targetRoomId = urlParams.get('roomId');

            // roomId が取得できなかった場合は処理を終了
            if (!targetRoomId) {
                console.error("URLパラメータ 'roomId' が見つかりません。");
                return null;
            }

            // ドキュメントの検索/特定 (findメソッドを使用)
            // document.id が targetRoomId と完全に合致する最初のドキュメントを検索
            const targetDocument = roomsDocuments.find(document => document.id === targetRoomId);

            // ドキュメントが見つからなかった場合は処理を終了
            if (!targetDocument) {
                console.warn(`ドキュメント ID: ${targetRoomId} に合致するデータは見つかりませんでした。`);
                return null;
            }
            
            // 必要なデータの抽出
            const data = targetDocument.data;

            const elements_room = [
                targetDocument.id,
                data.drawer_name,
                data.limit_seconds,
            ];
            return elements_room;
        }
        
        // 「Firestore 形式のデータ」を入力して「配列形式のデータ」を出力する関数を追加する
        function chatDocuments(fireStoreDocs) {
            const documents_chat = [];
            fireStoreDocs.forEach(function (doc) {
                const document_chat = {
                id: doc.id,
                data: doc.data(),
            };
            documents_chat.push(document_chat);
            });
            return documents_chat;
        }

        function chatElements(chatDocuments){
            const elements_chat =[];
            chatDocuments.forEach(function (document) {
                elements_chat.push(`
                <li id="${document.id}">
                    <p class="name_date">${document.data.user_name} at ${convertTimestampToDatetime(document.data.timestamp)}</p>
                    <p>${document.data.message}</p>
                </li>
                `);
            });
            return elements_chat;
        }

        // canvas関係
        //初期化(変数letで宣言)
        let canvas_mouse_event = false; //スイッチ [ true=線を引く, false=線は引かない ]  ＊＊＊
        let oldX = 0; //１つ前の座標を代入するための変数
        let oldY = 0; //１つ前の座標を代入するための変数
        let bold_line = 3; //ラインの太さをここで指定
        let color = "#000000"; //ラインの色をここで指定
        let line_points = []; //線の座標を入れる配列

        //描画の定義
        const can = $("#drow")[0];
        const ctx = can.getContext("2d");

        //mousedown：フラグをTrue
        $(can).on("mousedown",function(e){
            oldX = e.offsetX; //MOUSEDOWNしたX横座標取得
            oldY = e.offsetY; //MOUSEDOWN Y高さ座標取得
            canvas_mouse_event=true;

            // 配列に開始地点のデータを入れる
            line_points = [];
            line_points.push(oldX, oldY);
        });

        //mousemove：フラグがTrueだったら描く ※e：イベント引数取得
        $(can).on("mousemove",function(e){
            if(canvas_mouse_event==true){
                const px = e.offsetX;
                const py = e.offsetY;
                ctx.strokeStyle = color;
                ctx.lineWidth = bold_line;
                ctx.beginPath();
                ctx.lineJoin= "round";
                ctx.lineCap = "round";
                ctx.moveTo(oldX, oldY);
                ctx.lineTo(px, py);
                ctx.stroke();
                oldX = px;
                oldY = py;
                // 座標を配列に追加
                line_points.push(px, py);
            }
        });

        $(can).on("mouseup", async function(e){
            canvas_mouse_event=false;

            if (line_points.length >= 4) {

                // RoomIdの確認
                if (!currentRoomId) {
                    console.error("ルームIDが未設定のため、描画イベントを送信できません。");
                    return;
                }
                
                // firebaseに送るデータの定義
                const draw_Data = {
                    drawer_name: drawer_name,
                    operation_type: "line",
                    timestamp: serverTimestamp(),
                    data: { color: color , width: bold_line, points: line_points }, // オブジェクト形式で描画データ保存
                };
                
                // ドキュメントを追加、書き込み完了まで次の動作を待つ
                await addDoc(collection(db, 'rooms', currentRoomId, 'drawing'), draw_Data);
                
                console.log("Firestoreに描画イベントを送信しました");    

            }
            line_points = [];
        });

        // mouseleave：フラグをFalse (キャンバスからマウスが出たとき)
        $(can).on("mouseleave",function(e){
            canvas_mouse_event = false;
        });

        // mouseenter：再突入時のフラグチェック (より安全にするため)
        $(can).on("mouseenter",function(e){
            // マウスボタンが押されたままキャンバス外で離され、再度入ってきた場合の誤作動を防ぐ
            if (e.buttons !== 1) { // buttons === 1 は左クリックが押されている状態
                canvas_mouse_event = false;
            }
        });

        //#color-palette：色変更Action、firebaseに色変更のデータを送る
        $('#color-palette').on('change', async function(){
            const new_color = $(this).val();
            // グローバルに数値型に変更して入れる
            color = String(new_color);

            // RoomIdの確認
            if (!currentRoomId) {
                console.error("ルームIDが未設定のため、色変更イベントを送信できません。");
                return;
            }
            
            // firebaseに送るデータの定義
            const color_change_Data = {
                drawer_name: drawer_name,
                operation_type: "color_change",
                timestamp: serverTimestamp(),
                data: { new_color: String(new_color),}, // オブジェクト形式で色データ保存
            };
            
            // ドキュメントを追加、書き込み完了まで次の動作を待つ
            await addDoc(collection(db, 'rooms', currentRoomId, 'drawing'), color_change_Data);
            
            console.log("Firestoreに色変更イベントを送信しました。色: " + new_color);
        });


        //#clear_btn：クリアーボタンAction、firebaseにcleraのデータを送る
        $('#clear_btn').on('click',async function(){
           ctx.beginPath();
           ctx.clearRect(0, 0, can.width, can.height);

            if (!currentRoomId) {
                console.error("ルームIDが未設定のため、クリアイベントを送信できません。");
                return;
            }
            
            // firebaseに送るデータの定義
            const clearData = {
                drawer_name: drawer_name,
                operation_type: "clear",
                timestamp: serverTimestamp(),
                data: {}, // データは空のマップ
            };
            
            // ドキュメントを追加、書き込み完了まで次の動作を待つ
            await addDoc(collection(db, 'rooms', currentRoomId, 'drawing'), clearData);
            
            console.log("Firestoreにクリアイベントを送信しました。");
        });

        // 線の太さ、回転の速さのスライダーの数値を表示させる
        $(document).ready(function(){
            // 線の太さの初期設定
            $('#current_value_line').text(bold_line);
            // 線の太さが変わってもスライダーの数値を表示させる
            $('#line_weight').on('input', async function(){
                const new_value = $(this).val();
                $('#current_value_line').text(new_value);
                // グローバルに数値型に変更して入れる
                bold_line = Number(new_value);

                // RoomIdの確認
                if (!currentRoomId) {
                    console.error("ルームIDが未設定のため、太さ変更イベントを送信できません。");
                    return;
                }
                
                // firebaseに送るデータの定義
                const width_change_Data = {
                    drawer_name: drawer_name,
                    operation_type: "width_change",
                    timestamp: serverTimestamp(),
                    data: { new_width: Number(new_value),}, // オブジェクト形式で数値データをほおzん
                };
                
                // ドキュメントを追加、書き込み完了まで次の動作を待つ
                await addDoc(collection(db, 'rooms', currentRoomId, 'drawing'), width_change_Data);
                
                console.log("Firestoreに線の太さ変更イベントを送信しました。太さ: " + new_value);
            });

            // 回転の速さの初期設定
            // 別途定義しているのでそれに修正する必要あり
            $('#current_value_speed').text(spin_speed+"倍");
            // 回転の速さが変わってもスライダーの数値を表示させる
            $('#speed').on('input',function(){
                const new_value = $(this).val();
                $('#current_value_speed').text(new_value+"倍");
                // グローバルに数値型に変更して入れる
                spin_speed = Number(new_value);
            });

            let color = $('#color-pallet').val();

            start();
             
            });
             
        //one_more；テーマも絵も時間もリセット
        $('#one_more').on('click',function(){
            ctx.beginPath();
            ctx.clearRect(0, 0, can.width, can.height);
            odai_shuffle();
            countdown_flg=0;
            if(!confirm('もう1回やりますか？')){
                return false;
        
            }else
            resetGame();
            countdown_flg=1;
            start();
        });

        //go_top：HOMEに戻る
        $('#go_top').on('click',function(){
            window.location.href = 'index.html'; 
        });

        // テーマをランダムに決める関数の定義
        function odai_shuffle() {
            const odai = ['雪だるま', 'ライオン', 'うさぎ', 'アイス', 'いぬ', 'ネコ', 'ぞう', 'りんご', 'バナナ', 'いちご', 'メロン', 'ドラえもん', 'キティちゃん', 'アンパンマン', 'いえ', 'くじら', 'くるま', 'くまモン', 'ひこうき', 'ロボット', 'かいじゅう', 'おばけ', 'きょうりゅう', 'オムライス', 'えんぴつ', 'ほん', 'けいたい', 'みかん', 'スイカ', 'パンダ', 'きつね', 'かに', 'さかな', 'ちょうちょ', 'とら', 'かめ', 'ヘビ', 'ぶどう', 'おにぎり', 'ケーキ', 'チューリップ', 'にんげん', 'まほうつかい', 'おひめさま', 'たいよう', 'つき', 'かさ', 'ふうせん', 'くつ', 'ぼうし'];                
            const random = Math.floor(Math.random() * odai.length);
            const result = odai[random];
            $('#odai_frame').html("おだい<br>『"+result+"』");
        }

        // 時間をカウントダウンする関数
        function countdown(){
            if(countdown_flg==1){
                let cnt = time_limit; //制限時間を設定
                $('#timelimit').html('<p>'+cnt+' びょう</p>');
                cnDownTimerId = setInterval(
                    function(){ //1秒おきにカウントマイナス
                        cnt--;
                        if(cnt <= 10 && cnt > 0){
                            $('#timelimit').html('<p class="under10">'+cnt+' びょう</p>');
                        }
                        else if(cnt <= 0){//0になったら停止する
                            clearInterval(cnDownTimerId);
                            cnDownTimerId = null;
                            alert("タイムアップ")
                            $('#timelimit').html('<p>'+cnt+' びょう</p>');
                            countdown_flg = 0;
                        }else
                        $('#timelimit').html('<p>'+cnt+' びょう</p>');
                    },1000
                );
            }     
        }
        
        // カウントダウンスタート&お題セットの定義
        function start(){
            if (startTimerId) {
                clearTimeout(startTimerId);
            }

            startTimerId = setTimeout(function(){
                if(!confirm('じゅんびはいいですか？\n\n'+ currentRoomId+'\n\n↑ともだちに教えてください。')){
                    startTimerId = setTimeout(function(){
                        start();
                    },2000);
                }else{
                    // 部屋ドキュメントの参照を取得
                    const roomRef = doc(db, 'rooms', currentRoomId);
                    
                    // 部屋の状態を更新
                    updateDoc(roomRef, {
                        status: "playing",
                        start_time: serverTimestamp(), // サーバー時刻でスタート時間を記録
                    }).then(() => {
                        console.log("ゲームを開始しました (Firestore更新完了)。");
                        
                        // Firestoreの更新成功後、ローカルでカウントダウンを開始
                        countdown_flg = 1;
                        odai_shuffle();
                        countdown();
                    
                    }).catch(error => {
                        console.error("ゲーム開始情報の書き込みに失敗しました:", error);
                        alert("ゲーム開始に失敗しました。コンソールを確認してください。");
                    
                    });
                }
            },2000); 
        }

        // リセット関数
        function resetGame() {
            // カウントダウン（setInterval）を停止
            if (cnDownTimerId !== null) {
                clearInterval(cnDownTimerId);
                cnDownTimerId = null;
            }

            // スタート準備（setTimeout）を停止
            if (startTimerId !== null) {
                clearTimeout(startTimerId);
                startTimerId = null;
            }

            // カウントダウンフラグリセット
            countdown_flg = 0;
            
            // 画面のタイマー表示を初期値（time_limit）またはリセット状態に戻す
            $('#timelimit').html('<p>0 びょう</p>');
            
            $('#odai_frame').html('おだい<br>『---』');
        }

    </script>

</body>
</html>